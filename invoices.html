<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="utf-8" />
    <title>نظام إدارة الفواتير - Invoice Management System</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="7da0182d-1b3e-404e-8fb9-27f47dbd6113.jfif""
    type="image/x-icon">
    <style>
      * {
        box-sizing: border-box;
      }
      s body {
        font-family: "Segoe UI", Tahoma, Arial, sans-serif;
        direction: rtl;
        padding: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        min-height: 100vh;
      }
      .app {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        margin: 0;
        font-size: 2.5em;
        font-weight: 300;
      }
      .header p {
        margin: 10px 0 0;
        opacity: 0.9;
      }

      /* Language Switcher */
      .language-switcher {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        gap: 10px;
      }

      .lang-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .lang-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
      }

      .lang-btn.active {
        background: white;
        color: #667eea;
        border-color: white;
      }

      @media (max-width: 768px) {
        .language-switcher {
          position: static;
          justify-content: center;
          margin-bottom: 15px;
        }

        .lang-btn {
          font-size: 0.8em;
          padding: 6px 12px;
        }
      }

      .nav-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
      }
      .nav-tab {
        flex: 1;
        padding: 15px 20px;
        text-align: center;
        cursor: pointer;
        border: none;
        background: none;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s;
      }
      .nav-tab.active {
        background: white;
        color: #667eea;
        border-bottom: 3px solid #667eea;
      }
      .nav-tab:hover {
        background: #e9ecef;
      }

      .tab-content {
        padding: 30px;
        min-height: 600px;
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }

      label {
        display: block;
        margin-top: 12px;
        font-weight: 600;
        color: #495057;
      }
      input[type="number"],
      input[type="text"],
      input[type="email"],
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        box-sizing: border-box;
        margin-top: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }
      .col {
        flex: 1;
        min-width: 0;
      }
      .col-2 {
        flex: 2;
      }
      .col-3 {
        flex: 3;
      }

      .btn {
        margin: 8px 4px;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn-primary {
        background: #667eea;
        color: white;
      }
      .btn-primary:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-success:hover {
        background: #218838;
        transform: translateY(-2px);
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
      }
      .btn-outline {
        background: transparent;
        border: 2px solid #667eea;
        color: #667eea;
      }
      .btn-outline:hover {
        background: #667eea;
        color: white;
      }

      .invoice {
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 30px;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        direction: ltr;
        max-width: 800px;
        margin: 20px auto;
      }
      .center {
        text-align: center;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      th {
        background: #f8f9fa;
        padding: 15px 10px;
        border-bottom: 2px solid #dee2e6;
        text-align: right;
        font-weight: 600;
        color: #495057;
      }
      td {
        padding: 12px 10px;
        border-bottom: 1px solid #eee;
        text-align: right;
      }
      tr:hover {
        background: #f8f9fa;
      }
      .total {
        font-weight: 700;
        background: #e3f2fd;
      }

      .product-item,
      .customer-item,
      .invoice-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
      }
      .product-item:hover,
      .customer-item:hover,
      .invoice-item:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .item-actions {
        display: flex;
        gap: 5px;
        margin-top: 10px;
      }

      .search-box {
        position: relative;
        margin-bottom: 20px;
      }
      .search-box i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }
      .close {
        color: #aaa;
        float: left;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover {
        color: #000;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        text-align: center;
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }
      .stat-label {
        color: #6c757d;
        font-size: 0.9em;
      }

      .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
      }

      .business-info {
        flex: 1;
      }
      .invoice-meta {
        text-align: left;
        flex: 1;
      }

      @media (max-width: 768px) {
        .row {
          flex-direction: column;
        }
        .nav-tabs {
          flex-direction: column;
        }
        .invoice-header {
          flex-direction: column;
          text-align: center;
        }
        .stats-grid {
          grid-template-columns: 1fr;
        }
        .app {
          margin: 10px;
          border-radius: 10px;
        }
        .header h1 {
          font-size: 2em;
        }
      }

      /* Beautiful Alerts */
      .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 300px;
        max-width: 500px;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
        backdrop-filter: blur(10px);
      }

      .alert-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-left: 4px solid #1e7e34;
      }

      .alert-error {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
        border-left: 4px solid #bd2130;
      }

      .alert-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .alert-info {
        background: linear-gradient(135deg, #17a2b8, #6f42c1);
        color: white;
        border-left: 4px solid #117a8b;
      }

      .alert-icon {
        font-size: 1.2em;
        flex-shrink: 0;
      }

      .alert-content {
        flex: 1;
      }

      .alert-close {
        background: none;
        border: none;
        color: inherit;
        font-size: 1.5em;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.3s;
        padding: 0;
        margin: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .alert-close:hover {
        opacity: 1;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .alert.hide {
        animation: slideOutRight 0.3s ease-in forwards;
      }

      /* Form Validation Styles */
      .form-group {
        margin-bottom: 15px;
      }

      .form-group.error input,
      .form-group.error select,
      .form-group.error textarea {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
      }

      .form-group.success input,
      .form-group.success select,
      .form-group.success textarea {
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
      }

      .error-message {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .error-message::before {
        content: "⚠️";
        font-size: 0.9em;
      }

      .success-message {
        color: #28a745;
        font-size: 0.875em;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .success-message::before {
        content: "✅";
        font-size: 0.9em;
      }

      .required {
        color: #dc3545;
      }

      @media (max-width: 768px) {
        .alert {
          right: 10px;
          left: 10px;
          min-width: auto;
          max-width: none;
        }
      }

      @media print {
        body {
          background: white;
          font-family: "Segoe UI", Tahoma, Arial, sans-serif;
        }
        .nav-tabs,
        .controls,
        .btn,
        .modal,
        .alert {
          display: none;
        }
        .app {
          box-shadow: none;
          border-radius: 0;
        }
        .invoice {
          box-shadow: none;
          border: 1px solid #000;
          margin: 0;
          padding: 20px;
        }
        .invoice-header {
          border-bottom: 2px solid #667eea;
          padding-bottom: 20px;
          margin-bottom: 30px;
        }
        .invoice-meta {
          text-align: right;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        th,
        td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
        }
        th {
          background-color: #f8f9fa;
          font-weight: bold;
        }
        .total td {
          background-color: #e3f2fd;
          font-weight: bold;
        }
        #invoiceDisplay {
          display: block !important;
        }
        .app {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <div class="app">
      <div class="header">
        <div class="language-switcher">
          <button class="lang-btn" onclick="changeLanguage('ar')" id="arBtn">
            <i class="fas fa-globe"></i> العربية
          </button>
          <button class="lang-btn" onclick="changeLanguage('en')" id="enBtn">
            <i class="fas fa-globe"></i> English
          </button>
        </div>
        <h1>
          <i class="fas fa-file-invoice"></i>
          <span data-translate="app_title">نظام إدارة الفواتير</span>
        </h1>
        <p data-translate="app_subtitle">
          نظام شامل لإدارة الفواتير والعملاء والمنتجات
        </p>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('dashboard')">
          <i class="fas fa-tachometer-alt"></i>
          <span data-translate="dashboard">لوحة التحكم</span>
        </button>
        <button class="nav-tab" onclick="showTab('invoices')">
          <i class="fas fa-file-invoice"></i>
          <span data-translate="invoices">الفواتير</span>
        </button>
        <button class="nav-tab" onclick="showTab('products')">
          <i class="fas fa-box"></i>
          <span data-translate="products">المنتجات</span>
        </button>
        <button class="nav-tab" onclick="showTab('customers')">
          <i class="fas fa-users"></i>
          <span data-translate="customers">العملاء</span>
        </button>
        <button class="nav-tab" onclick="showTab('settings')">
          <i class="fas fa-cog"></i>
          <span data-translate="settings">الإعدادات</span>
        </button>
      </div>

      <div class="tab-content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-panel active">
          <h2>
            <i class="fas fa-chart-bar"></i>
            <span data-translate="quick_stats">إحصائيات سريعة</span>
          </h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalInvoices">0</div>
              <div class="stat-label" data-translate="total_invoices">
                إجمالي الفواتير
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalRevenue">0</div>
              <div class="stat-label" data-translate="total_revenue">
                إجمالي الإيرادات
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalCustomers">0</div>
              <div class="stat-label" data-translate="total_customers">
                إجمالي العملاء
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalProducts">0</div>
              <div class="stat-label" data-translate="total_products">
                إجمالي المنتجات
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <h3 data-translate="recent_invoices">أحدث الفواتير</h3>
              <div id="recentInvoices"></div>
            </div>
            <div class="col">
              <h3 data-translate="top_customers">أفضل العملاء</h3>
              <div id="topCustomers"></div>
            </div>
          </div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoices" class="tab-panel">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2>
              <i class="fas fa-file-invoice"></i>
              <span data-translate="invoice_management">إدارة الفواتير</span>
            </h2>
            <button class="btn btn-primary" onclick="openInvoiceModal()">
              <i class="fas fa-plus"></i>
              <span data-translate="new_invoice">فاتورة جديدة</span>
            </button>
          </div>

          <div class="search-box">
            <input
              type="text"
              id="invoiceSearch"
              placeholder="البحث في الفواتير..."
              onkeyup="filterInvoices()"
            />
            <i class="fas fa-search"></i>
          </div>

          <div id="invoicesList"></div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-panel">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2>
              <i class="fas fa-box"></i>
              <span data-translate="product_management">إدارة المنتجات</span>
            </h2>
            <button class="btn btn-primary" onclick="openProductModal()">
              <i class="fas fa-plus"></i>
              <span data-translate="new_product">منتج جديد</span>
            </button>
          </div>

          <div class="search-box">
            <input
              type="text"
              id="productSearch"
              placeholder="البحث في المنتجات..."
              onkeyup="filterProducts()"
            />
            <i class="fas fa-search"></i>
          </div>

          <div id="productsList"></div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-panel">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2>
              <i class="fas fa-users"></i>
              <span data-translate="customer_management">إدارة العملاء</span>
            </h2>
            <button class="btn btn-primary" onclick="openCustomerModal()">
              <i class="fas fa-plus"></i>
              <span data-translate="new_customer">عميل جديد</span>
            </button>
          </div>

          <div class="search-box">
            <input
              type="text"
              id="customerSearch"
              placeholder="البحث في العملاء..."
              onkeyup="filterCustomers()"
            />
            <i class="fas fa-search"></i>
          </div>

          <div id="customersList"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-panel">
          <h2>
            <i class="fas fa-cog"></i>
            <span data-translate="company_settings">إعدادات الشركة</span>
          </h2>

          <div class="row">
            <div class="col">
              <div class="form-group">
                <label data-translate="company_name"
                  >اسم الشركة <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="companyName"
                  placeholder="اسم الشركة"
                  required
                />
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label data-translate="company_phone">رقم الهاتف</label>
                <input type="text" id="companyPhone" placeholder="رقم الهاتف" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="form-group">
                <label data-translate="company_email">البريد الإلكتروني</label>
                <input
                  type="email"
                  id="companyEmail"
                  placeholder="البريد الإلكتروني"
                />
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label data-translate="company_website"
                  >الموقع الإلكتروني</label
                >
                <input
                  type="text"
                  id="companyWebsite"
                  placeholder="الموقع الإلكتروني"
                />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label data-translate="company_address"
              >عنوان الشركة <span class="required">*</span></label
            >
            <textarea
              id="companyAddress"
              placeholder="عنوان الشركة الكامل"
              rows="3"
              required
            ></textarea>
          </div>

          <div class="row">
            <div class="col">
              <div class="form-group">
                <label data-translate="default_tax_rate">
                  نسبة الضريبة الافتراضية (%)
                  <span class="required">*</span></label
                >
                <input
                  type="number"
                  id="defaultTaxRate"
                  step="0.01"
                  value="14"
                  required
                  min="0"
                  max="100"
                />
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label data-translate="invoice_currency"
                  >عملة الفاتورة <span class="required">*</span></label
                >
                <select id="defaultCurrency" required>
                  <option value="AED" data-translate="aed">
                    درهم إماراتي (AED)
                  </option>
                  <option value="USD" data-translate="usd">
                    دولار أمريكي (USD)
                  </option>
                  <option value="EUR" data-translate="eur">يورو (EUR)</option>
                  <option value="SAR" data-translate="sar">
                    ريال سعودي (SAR)
                  </option>
                </select>
              </div>
            </div>
          </div>

          <button class="btn btn-success" onclick="saveSettings()">
            <i class="fas fa-save"></i>
            <span data-translate="save_settings">حفظ الإعدادات</span>
          </button>

          <button class="btn btn-outline" onclick="exportData()">
            <i class="fas fa-download"></i>
            <span data-translate="export_data">تصدير البيانات</span>
          </button>

          <button class="btn btn-outline" onclick="importData()">
            <i class="fas fa-upload"></i>
            <span data-translate="import_data">استيراد البيانات</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('invoiceModal')">&times;</span>
        <h2><i class="fas fa-file-invoice"></i> فاتورة جديدة</h2>

        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>رقم الفاتورة</label>
              <input type="text" id="invoiceNumber" readonly />
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>تاريخ الفاتورة <span class="required">*</span></label>
              <input type="date" id="invoiceDate" required />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>العميل <span class="required">*</span></label>
          <select id="invoiceCustomer" required>
            <option value="">اختر عميل...</option>
          </select>
        </div>

        <div class="form-group">
          <label>طريقة الدفع <span class="required">*</span></label>
          <select id="paymentMethod" required>
            <option value="cash">نقداً</option>
            <option value="card">بطاقة ائتمان</option>
            <option value="bank">تحويل بنكي</option>
            <option value="check">شيك</option>
          </select>
        </div>

        <div class="form-group">
          <label>أيام الاستحقاق <span class="required">*</span></label>
          <input type="number" id="dueDays" value="30" min="1" required />
        </div>

        <h3>عناصر الفاتورة</h3>
        <div id="invoiceItems">
          <div class="invoice-item">
            <div class="row">
              <div class="col-3">
                <label>المنتج/الخدمة</label>
                <select class="item-product" onchange="updateItemPrice(this)">
                  <option value="">اختر منتج...</option>
                </select>
              </div>
              <div class="col">
                <label>الكمية</label>
                <input
                  type="number"
                  class="item-quantity"
                  value="1"
                  min="1"
                  onchange="calculateItemTotal(this)"
                />
              </div>
              <div class="col">
                <label>السعر</label>
                <input
                  type="number"
                  class="item-price"
                  step="0.01"
                  onchange="calculateItemTotal(this)"
                />
              </div>
              <div class="col">
                <label>الإجمالي</label>
                <input type="number" class="item-total" step="0.01" readonly />
              </div>
              <div class="col">
                <button class="btn btn-danger" onclick="removeItem(this)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <button class="btn btn-secondary" onclick="addInvoiceItem()">
          <i class="fas fa-plus"></i> إضافة عنصر
        </button>

        <div class="row" style="margin-top: 20px">
          <div class="col">
            <div class="form-group">
              <label>نسبة الضريبة (%) <span class="required">*</span></label>
              <input
                type="number"
                id="invoiceTaxRate"
                step="0.01"
                value="14"
                min="0"
                max="100"
                onchange="calculateInvoiceTotal()"
                required
              />
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>خصم (%)</label>
              <input
                type="number"
                id="invoiceDiscount"
                step="0.01"
                value="0"
                min="0"
                max="100"
                onchange="calculateInvoiceTotal()"
              />
            </div>
          </div>
        </div>

        <div
          style="
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
          "
        >
          <div style="display: flex; justify-content: space-between">
            <span>المجموع الفرعي:</span>
            <span id="subtotal">0.00</span>
          </div>
          <div style="display: flex; justify-content: space-between">
            <span>الخصم:</span>
            <span id="discountAmount">0.00</span>
          </div>
          <div style="display: flex; justify-content: space-between">
            <span>الضريبة:</span>
            <span id="taxAmount">0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              font-weight: bold;
              font-size: 1.2em;
            "
          >
            <span>المجموع الكلي:</span>
            <span id="totalAmount">0.00</span>
          </div>
        </div>

        <div class="form-group">
          <label>ملاحظات</label>
          <textarea
            id="invoiceNotes"
            placeholder="ملاحظات إضافية..."
            rows="3"
          ></textarea>
        </div>

        <div style="margin-top: 20px; text-align: center">
          <button class="btn btn-success" onclick="saveInvoice()">
            <i class="fas fa-save"></i> حفظ الفاتورة
          </button>
          <button class="btn btn-primary" onclick="saveAndPrintInvoice()">
            <i class="fas fa-print"></i> حفظ وطباعة
          </button>
          <button
            class="btn btn-secondary"
            onclick="closeModal('invoiceModal')"
          >
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('productModal')">&times;</span>
        <h2><i class="fas fa-box"></i> منتج جديد</h2>

        <div class="form-group">
          <label>اسم المنتج/الخدمة <span class="required">*</span></label>
          <input
            type="text"
            id="productName"
            placeholder="اسم المنتج أو الخدمة"
            required
          />
        </div>

        <div class="form-group">
          <label>وصف المنتج</label>
          <textarea
            id="productDescription"
            placeholder="وصف المنتج..."
            rows="3"
          ></textarea>
        </div>

        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>السعر <span class="required">*</span></label>
              <input
                type="number"
                id="productPrice"
                step="0.01"
                placeholder="0.00"
                required
                min="0"
              />
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>الوحدة</label>
              <input
                type="text"
                id="productUnit"
                placeholder="قطعة، كيلو، ساعة..."
              />
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>فئة المنتج</label>
              <input
                type="text"
                id="productCategory"
                placeholder="فئة المنتج"
              />
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>الكمية المتاحة</label>
              <input type="number" id="productStock" min="0" placeholder="0" />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>كود المنتج</label>
          <input
            type="text"
            id="productCode"
            placeholder="كود المنتج (اختياري)"
          />
        </div>

        <div style="margin-top: 20px; text-align: center">
          <button class="btn btn-success" onclick="saveProduct()">
            <i class="fas fa-save"></i> حفظ المنتج
          </button>
          <button
            class="btn btn-secondary"
            onclick="closeModal('productModal')"
          >
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('customerModal')">&times;</span>
        <h2><i class="fas fa-user"></i> عميل جديد</h2>

        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>اسم العميل/الشركة <span class="required">*</span></label>
              <input
                type="text"
                id="customerName"
                placeholder="اسم العميل أو الشركة"
                required
              />
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>نوع العميل</label>
              <select id="customerType">
                <option value="individual">فرد</option>
                <option value="company">شركة</option>
              </select>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>رقم الهاتف</label>
              <input type="text" id="customerPhone" placeholder="رقم الهاتف" />
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>البريد الإلكتروني</label>
              <input
                type="email"
                id="customerEmail"
                placeholder="البريد الإلكتروني"
              />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>العنوان</label>
          <textarea
            id="customerAddress"
            placeholder="عنوان العميل..."
            rows="3"
          ></textarea>
        </div>

        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>رقم الضريبة</label>
              <input
                type="text"
                id="customerTaxNumber"
                placeholder="رقم الضريبة"
              />
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>رقم الهوية/التجاري</label>
              <input
                type="text"
                id="customerIdNumber"
                placeholder="رقم الهوية أو التجاري"
              />
            </div>
          </div>
        </div>

        <div style="margin-top: 20px; text-align: center">
          <button class="btn btn-success" onclick="saveCustomer()">
            <i class="fas fa-save"></i> حفظ العميل
          </button>
          <button
            class="btn btn-secondary"
            onclick="closeModal('customerModal')"
          >
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <!-- Invoice Display -->
    <div id="invoiceDisplay" class="invoice" style="display: none">
      <div class="invoice-header">
        <div class="business-info">
          <div
            style="
              display: flex;
              align-items: center;
              gap: 15px;
              margin-bottom: 15px;
            "
          >
            <img
              src="7da0182d-1b3e-404e-8fb9-27f47dbd6113.jfif"
              alt="Company Logo"
              style="
                width: 80px;
                height: 80px;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              "
            />
            <div>
              <h3
                id="displayCompanyName"
                style="margin: 0; font-size: 1.8em; color: #667eea"
              >
                Company Name
              </h3>
              <div
                id="displayCompanyAddress"
                style="color: #6c757d; margin-top: 5px"
              >
                Address
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 20px; flex-wrap: wrap">
            <div>
              <strong>Phone:</strong> <span id="displayCompanyPhone">---</span>
            </div>
            <div>
              <strong>Email:</strong> <span id="displayCompanyEmail">---</span>
            </div>
          </div>
        </div>
        <div class="invoice-meta">
          <h2 style="color: #667eea; margin: 0; text-align: left">
            TAX INVOICE
          </h2>
          <div style="margin-top: 10px; text-align: left">
            <div>
              <strong>Invoice No:</strong>
              <span id="displayInvoiceNumber">---</span>
            </div>
            <div>
              <strong>Date:</strong> <span id="displayInvoiceDate">---</span>
            </div>
            <div>
              <strong>Due Date:</strong> <span id="displayDueDate">---</span>
            </div>
            <div>
              <strong>Payment Method:</strong>
              <span id="displayPaymentMethod">---</span>
            </div>
          </div>
        </div>
      </div>

      <div style="margin: 30px 0">
        <h4 style="text-align: left; margin-bottom: 15px; color: #495057">
          BILL TO:
        </h4>
        <div
          id="displayCustomerInfo"
          style="
            text-align: left;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
          "
        ></div>
      </div>

      <table style="direction: ltr">
        <thead>
          <tr>
            <th style="text-align: left">Description</th>
            <th style="text-align: center">Quantity</th>
            <th style="text-align: center">Unit</th>
            <th style="text-align: center">Price</th>
            <th style="text-align: right">Total</th>
          </tr>
        </thead>
        <tbody id="displayItemsBody"></tbody>
      </table>

      <div style="margin-top: 30px">
        <div style="display: flex; justify-content: flex-end">
          <div style="width: 300px">
            <table style="direction: ltr">
              <tbody>
                <tr>
                  <td style="text-align: right"><strong>Subtotal:</strong></td>
                  <td style="text-align: right" id="displaySubtotal">0.00</td>
                </tr>
                <tr>
                  <td style="text-align: right"><strong>Discount:</strong></td>
                  <td style="text-align: right" id="displayDiscount">0.00</td>
                </tr>
                <tr>
                  <td style="text-align: right"><strong>Tax:</strong></td>
                  <td style="text-align: right" id="displayTax">0.00</td>
                </tr>
                <tr class="total">
                  <td style="text-align: right"><strong>TOTAL:</strong></td>
                  <td style="text-align: right" id="displayTotal">0.00</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="margin-top: 30px" id="displayNotes"></div>

      <div
        style="
          margin-top: 30px;
          text-align: center;
          padding: 20px;
          border-top: 2px solid #e9ecef;
        "
      >
        <button class="btn btn-primary" onclick="printInvoice()">
          <i class="fas fa-print"></i> طباعة الفاتورة
        </button>
        <button class="btn btn-secondary" onclick="closeInvoiceDisplay()">
          إغلاق
        </button>
      </div>
    </div>

    <script>
      // Global variables
      let invoices = [];
      let products = [];
      let customers = [];
      let settings = {};
      let currentInvoiceNumber = 1;
      let currentLanguage = localStorage.getItem("language") || "ar";

      // Translation System
      const translations = {
        ar: {
          // App
          app_title: "نظام إدارة الفواتير",
          app_subtitle: "نظام شامل لإدارة الفواتير والعملاء والمنتجات",

          // Navigation
          dashboard: "لوحة التحكم",
          invoices: "الفواتير",
          products: "المنتجات",
          customers: "العملاء",
          settings: "الإعدادات",

          // Dashboard
          quick_stats: "إحصائيات سريعة",
          total_invoices: "إجمالي الفواتير",
          total_revenue: "إجمالي الإيرادات",
          total_customers: "إجمالي العملاء",
          total_products: "إجمالي المنتجات",
          recent_invoices: "أحدث الفواتير",
          top_customers: "أفضل العملاء",
          no_invoices: "لا توجد فواتير",
          no_data: "لا توجد بيانات",

          // Invoices
          invoice_management: "إدارة الفواتير",
          new_invoice: "فاتورة جديدة",
          search_invoices: "البحث في الفواتير...",
          no_invoices_msg: "لا توجد فواتير. ابدأ بإنشاء فاتورة جديدة.",
          invoice_number: "رقم الفاتورة",
          invoice_date: "تاريخ الفاتورة",
          customer: "العميل",
          choose_customer: "اختر عميل...",
          payment_method: "طريقة الدفع",
          due_days: "أيام الاستحقاق",
          invoice_items: "عناصر الفاتورة",
          add_item: "إضافة عنصر",
          tax_rate: "نسبة الضريبة (%)",
          discount: "خصم (%)",
          subtotal: "المجموع الفرعي:",
          discount_amount: "الخصم:",
          tax_amount: "الضريبة:",
          total: "المجموع الكلي:",
          notes: "ملاحظات",
          additional_notes: "ملاحظات إضافية...",
          save_invoice: "حفظ الفاتورة",
          save_print_invoice: "حفظ وطباعة",
          cancel: "إلغاء",
          invoice_notes: "ملاحظات:",
          print_invoice: "طباعة الفاتورة",
          close: "إغلاق",
          view: "عرض",
          edit: "تعديل",
          delete: "حذف",
          items: "عنصر",
          cash: "نقداً",
          card: "بطاقة ائتمان",
          bank: "تحويل بنكي",
          check: "شيك",
          customer_undefined: "عميل غير محدد",

          // Products
          product_management: "إدارة المنتجات",
          new_product: "منتج جديد",
          search_products: "البحث في المنتجات...",
          no_products_msg: "لا توجد منتجات. ابدأ بإضافة منتج جديد.",
          product_name: "اسم المنتج/الخدمة",
          product_name_placeholder: "اسم المنتج أو الخدمة",
          product_description: "وصف المنتج",
          product_description_placeholder: "وصف المنتج...",
          price: "السعر",
          unit: "الوحدة",
          unit_placeholder: "قطعة، كيلو، ساعة...",
          category: "فئة المنتج",
          category_placeholder: "فئة المنتج",
          stock: "الكمية المتاحة",
          product_code: "كود المنتج",
          product_code_placeholder: "كود المنتج (اختياري)",
          save_product: "حفظ المنتج",
          update_product: "تحديث المنتج",
          no_description: "لا يوجد وصف",
          product_code_label: "كود المنتج:",

          // Customers
          customer_management: "إدارة العملاء",
          new_customer: "عميل جديد",
          search_customers: "البحث في العملاء...",
          no_customers_msg: "لا توجد عملاء. ابدأ بإضافة عميل جديد.",
          customer_name: "اسم العميل/الشركة",
          customer_name_placeholder: "اسم العميل أو الشركة",
          customer_type: "نوع العميل",
          individual: "فرد",
          company: "شركة",
          phone: "رقم الهاتف",
          phone_placeholder: "رقم الهاتف",
          email: "البريد الإلكتروني",
          email_placeholder: "البريد الإلكتروني",
          address: "العنوان",
          address_placeholder: "عنوان العميل...",
          tax_number: "رقم الضريبة",
          tax_number_placeholder: "رقم الضريبة",
          id_number: "رقم الهوية/التجاري",
          id_number_placeholder: "رقم الهوية أو التجاري",
          save_customer: "حفظ العميل",
          update_customer: "تحديث العميل",
          tax_number_label: "رقم الضريبة:",
          id_number_label: "رقم الهوية:",

          // Settings
          company_settings: "إعدادات الشركة",
          company_name: "اسم الشركة",
          company_name_placeholder: "اسم الشركة",
          company_phone: "رقم الهاتف",
          company_phone_placeholder: "رقم الهاتف",
          company_email: "البريد الإلكتروني",
          company_email_placeholder: "البريد الإلكتروني",
          company_website: "الموقع الإلكتروني",
          company_website_placeholder: "الموقع الإلكتروني",
          company_address: "عنوان الشركة",
          company_address_placeholder: "عنوان الشركة الكامل",
          default_tax_rate: "نسبة الضريبة الافتراضية (%)",
          invoice_currency: "عملة الفاتورة",
          aed: "درهم إماراتي (AED)",
          usd: "دولار أمريكي (USD)",
          eur: "يورو (EUR)",
          sar: "ريال سعودي (SAR)",
          save_settings: "حفظ الإعدادات",
          export_data: "تصدير البيانات",
          import_data: "استيراد البيانات",

          // Validation Messages
          field_required: "هذا الحقل مطلوب",
          invalid_email: "يرجى إدخال بريد إلكتروني صحيح",
          invalid_number: "يرجى إدخال رقم صحيح أكبر من أو يساوي صفر",
          fix_form_errors: "يرجى تصحيح الأخطاء في النموذج",
          min_one_item: "يجب أن تحتوي الفاتورة على عنصر واحد على الأقل",

          // Success Messages
          product_saved: "تم حفظ المنتج بنجاح",
          product_updated: "تم تحديث المنتج بنجاح",
          product_deleted: "تم حذف المنتج بنجاح",
          customer_saved: "تم حفظ العميل بنجاح",
          customer_updated: "تم تحديث العميل بنجاح",
          customer_deleted: "تم حذف العميل بنجاح",
          invoice_saved: "تم حفظ الفاتورة بنجاح",
          invoice_deleted: "تم حذف الفاتورة بنجاح",
          settings_saved: "تم حفظ الإعدادات بنجاح",
          data_exported: "تم تصدير البيانات بنجاح",
          data_imported: "تم استيراد البيانات بنجاح",

          // Error Messages
          invoice_number_required: "يرجى إدخال رقم الفاتورة",
          invoice_date_required: "يرجى إدخال تاريخ الفاتورة",
          invoice_items_required: "يرجى إضافة عنصر واحد على الأقل للفاتورة",
          import_error: "خطأ في استيراد البيانات. تأكد من أن الملف صحيح.",

          // Confirmations
          delete_product: "هل أنت متأكد من حذف هذا المنتج؟",
          delete_customer: "هل أنت متأكد من حذف هذا العميل؟",
          delete_invoice: "هل أنت متأكد من حذف هذه الفاتورة؟",

          // Info Messages
          edit_invoice_coming: "تعديل الفواتير سيتم إضافته في الإصدار القادم",
        },
        en: {
          // App
          app_title: "Invoice Management System",
          app_subtitle:
            "Comprehensive system for managing invoices, customers and products",

          // Navigation
          dashboard: "Dashboard",
          invoices: "Invoices",
          products: "Products",
          customers: "Customers",
          settings: "Settings",

          // Dashboard
          quick_stats: "Quick Statistics",
          total_invoices: "Total Invoices",
          total_revenue: "Total Revenue",
          total_customers: "Total Customers",
          total_products: "Total Products",
          recent_invoices: "Recent Invoices",
          top_customers: "Top Customers",
          no_invoices: "No invoices",
          no_data: "No data",

          // Invoices
          invoice_management: "Invoice Management",
          new_invoice: "New Invoice",
          search_invoices: "Search invoices...",
          no_invoices_msg: "No invoices. Start by creating a new invoice.",
          invoice_number: "Invoice Number",
          invoice_date: "Invoice Date",
          customer: "Customer",
          choose_customer: "Choose customer...",
          payment_method: "Payment Method",
          due_days: "Due Days",
          invoice_items: "Invoice Items",
          add_item: "Add Item",
          tax_rate: "Tax Rate (%)",
          discount: "Discount (%)",
          subtotal: "Subtotal:",
          discount_amount: "Discount:",
          tax_amount: "Tax:",
          total: "Total:",
          notes: "Notes",
          additional_notes: "Additional notes...",
          save_invoice: "Save Invoice",
          save_print_invoice: "Save & Print",
          cancel: "Cancel",
          invoice_notes: "Notes:",
          print_invoice: "Print Invoice",
          close: "Close",
          view: "View",
          edit: "Edit",
          delete: "Delete",
          items: "items",
          cash: "Cash",
          card: "Credit Card",
          bank: "Bank Transfer",
          check: "Check",
          customer_undefined: "Undefined Customer",

          // Products
          product_management: "Product Management",
          new_product: "New Product",
          search_products: "Search products...",
          no_products_msg: "No products. Start by adding a new product.",
          product_name: "Product/Service Name",
          product_name_placeholder: "Product or service name",
          product_description: "Product Description",
          product_description_placeholder: "Product description...",
          price: "Price",
          unit: "Unit",
          unit_placeholder: "piece, kg, hour...",
          category: "Product Category",
          category_placeholder: "Product category",
          stock: "Available Quantity",
          product_code: "Product Code",
          product_code_placeholder: "Product code (optional)",
          save_product: "Save Product",
          update_product: "Update Product",
          no_description: "No description",
          product_code_label: "Product Code:",

          // Customers
          customer_management: "Customer Management",
          new_customer: "New Customer",
          search_customers: "Search customers...",
          no_customers_msg: "No customers. Start by adding a new customer.",
          customer_name: "Customer/Company Name",
          customer_name_placeholder: "Customer or company name",
          customer_type: "Customer Type",
          individual: "Individual",
          company: "Company",
          phone: "Phone Number",
          phone_placeholder: "Phone number",
          email: "Email",
          email_placeholder: "Email address",
          address: "Address",
          address_placeholder: "Customer address...",
          tax_number: "Tax Number",
          tax_number_placeholder: "Tax number",
          id_number: "ID/Trade Number",
          id_number_placeholder: "ID or trade number",
          save_customer: "Save Customer",
          update_customer: "Update Customer",
          tax_number_label: "Tax Number:",
          id_number_label: "ID Number:",

          // Settings
          company_settings: "Company Settings",
          company_name: "Company Name",
          company_name_placeholder: "Company name",
          company_phone: "Phone Number",
          company_phone_placeholder: "Phone number",
          company_email: "Email",
          company_email_placeholder: "Email address",
          company_website: "Website",
          company_website_placeholder: "Website URL",
          company_address: "Company Address",
          company_address_placeholder: "Full company address",
          default_tax_rate: "Default Tax Rate (%)",
          invoice_currency: "Invoice Currency",
          aed: "UAE Dirham (AED)",
          usd: "US Dollar (USD)",
          eur: "Euro (EUR)",
          sar: "Saudi Riyal (SAR)",
          save_settings: "Save Settings",
          export_data: "Export Data",
          import_data: "Import Data",

          // Validation Messages
          field_required: "This field is required",
          invalid_email: "Please enter a valid email address",
          invalid_number:
            "Please enter a valid number greater than or equal to zero",
          fix_form_errors: "Please fix the errors in the form",
          min_one_item: "Invoice must contain at least one item",

          // Success Messages
          product_saved: "Product saved successfully",
          product_updated: "Product updated successfully",
          product_deleted: "Product deleted successfully",
          customer_saved: "Customer saved successfully",
          customer_updated: "Customer updated successfully",
          customer_deleted: "Customer deleted successfully",
          invoice_saved: "Invoice saved successfully",
          invoice_deleted: "Invoice deleted successfully",
          settings_saved: "Settings saved successfully",
          data_exported: "Data exported successfully",
          data_imported: "Data imported successfully",

          // Error Messages
          invoice_number_required: "Please enter invoice number",
          invoice_date_required: "Please enter invoice date",
          invoice_items_required: "Please add at least one item to the invoice",
          import_error: "Error importing data. Make sure the file is correct.",

          // Confirmations
          delete_product: "Are you sure you want to delete this product?",
          delete_customer: "Are you sure you want to delete this customer?",
          delete_invoice: "Are you sure you want to delete this invoice?",

          // Info Messages
          edit_invoice_coming:
            "Invoice editing will be added in the next version",
        },
      };

      // Translation Functions
      function translatePage(lang) {
        const elements = document.querySelectorAll("[data-translate]");
        elements.forEach((element) => {
          const key = element.getAttribute("data-translate");
          if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
          }
        });

        // Update page direction
        document.body.style.direction = lang === "ar" ? "rtl" : "ltr";
        document.documentElement.lang = lang;

        // Update active language button
        document.querySelectorAll(".lang-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.getElementById(lang + "Btn").classList.add("active");

        // Update placeholders
        updatePlaceholders(lang);
      }

      function updatePlaceholders(lang) {
        const placeholderMap = {
          productName: "product_name_placeholder",
          productDescription: "product_description_placeholder",
          productUnit: "unit_placeholder",
          productCategory: "category_placeholder",
          productCode: "product_code_placeholder",
          customerName: "customer_name_placeholder",
          customerPhone: "phone_placeholder",
          customerEmail: "email_placeholder",
          customerAddress: "address_placeholder",
          customerTaxNumber: "tax_number_placeholder",
          customerIdNumber: "id_number_placeholder",
          companyName: "company_name_placeholder",
          companyPhone: "company_phone_placeholder",
          companyEmail: "company_email_placeholder",
          companyWebsite: "company_website_placeholder",
          companyAddress: "company_address_placeholder",
          invoiceSearch: "search_invoices",
          productSearch: "search_products",
          customerSearch: "search_customers",
          invoiceNotes: "additional_notes",
        };

        Object.keys(placeholderMap).forEach((id) => {
          const element = document.getElementById(id);
          if (
            element &&
            translations[lang] &&
            translations[lang][placeholderMap[id]]
          ) {
            element.placeholder = translations[lang][placeholderMap[id]];
          }
        });

        // Update select options
        document
          .querySelectorAll("option[data-translate]")
          .forEach((option) => {
            const key = option.getAttribute("data-translate");
            if (translations[lang] && translations[lang][key]) {
              option.textContent = translations[lang][key];
            }
          });
      }

      function changeLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem("language", lang);
        translatePage(lang);
        showAlert(
          lang === "ar"
            ? "تم تغيير اللغة إلى العربية"
            : "Language changed to English",
          "success",
          3000
        );
      }

      function getTranslation(key) {
        return translations[currentLanguage] &&
          translations[currentLanguage][key]
          ? translations[currentLanguage][key]
          : key;
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        loadData();
        initializeApp();
        translatePage(currentLanguage); // Apply saved language
        updateDashboard();
        loadLists();
      });

      // Data management functions
      function saveData() {
        localStorage.setItem("invoices", JSON.stringify(invoices));
        localStorage.setItem("products", JSON.stringify(products));
        localStorage.setItem("customers", JSON.stringify(customers));
        localStorage.setItem("settings", JSON.stringify(settings));
        localStorage.setItem("invoiceNumber", currentInvoiceNumber.toString());
      }

      function loadData() {
        invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
        products = JSON.parse(localStorage.getItem("products") || "[]");
        customers = JSON.parse(localStorage.getItem("customers") || "[]");
        settings = JSON.parse(localStorage.getItem("settings") || "{}");
        currentInvoiceNumber = parseInt(
          localStorage.getItem("invoiceNumber") || "1"
        );
      }

      // Tab management
      function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-panel").forEach((panel) => {
          panel.classList.remove("active");
        });
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName).classList.add("active");
        document
          .querySelector(`[onclick="showTab('${tabName}')"]`)
          .classList.add("active");

        // Load data for specific tabs
        if (tabName === "invoices") {
          loadInvoicesList();
        } else if (tabName === "products") {
          loadProductsList();
        } else if (tabName === "customers") {
          loadCustomersList();
        }
      }

      // Modal management
      function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        // Clear form if it's a new item modal
        if (modalId.includes("Modal")) {
          document.querySelector(`#${modalId} form`)?.reset();
        }
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };

      // Utility functions
      function formatCurrency(amount) {
        return Number(amount).toLocaleString("ar-EG", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      // Dashboard functions
      function updateDashboard() {
        const totalInvoices = invoices.length;
        const totalRevenue = invoices.reduce(
          (sum, invoice) => sum + (invoice.total || 0),
          0
        );
        const totalCustomers = customers.length;
        const totalProducts = products.length;

        document.getElementById("totalInvoices").textContent = totalInvoices;
        document.getElementById("totalRevenue").textContent =
          formatCurrency(totalRevenue);
        document.getElementById("totalCustomers").textContent = totalCustomers;
        document.getElementById("totalProducts").textContent = totalProducts;

        // Load recent invoices
        loadRecentInvoices();
        loadTopCustomers();
      }

      function loadRecentInvoices() {
        const recentInvoices = invoices.slice(-5).reverse();
        const container = document.getElementById("recentInvoices");

        if (recentInvoices.length === 0) {
          container.innerHTML = `<p style="color: #6c757d; text-align: center;">${getTranslation(
            "no_invoices"
          )}</p>`;
          return;
        }

        container.innerHTML = recentInvoices
          .map(
            (invoice) => `
          <div class="invoice-item" style="padding: 10px; margin: 5px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>فاتورة #${invoice.number}</strong>
                <div style="font-size: 0.9em; color: #6c757d;">
                  ${new Date(invoice.date).toLocaleDateString("ar-EG")} - ${
              invoice.customerName || "عميل غير محدد"
            }
                </div>
              </div>
              <div style="font-weight: bold; color: #28a745;">
                ${formatCurrency(invoice.total)} ${settings.currency || "AED"}
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      function loadTopCustomers() {
        const customerTotals = {};
        invoices.forEach((invoice) => {
          const customerName = invoice.customerName || "عميل غير محدد";
          customerTotals[customerName] =
            (customerTotals[customerName] || 0) + (invoice.total || 0);
        });

        const topCustomers = Object.entries(customerTotals)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 5);

        const container = document.getElementById("topCustomers");

        if (topCustomers.length === 0) {
          container.innerHTML = `<p style="color: #6c757d; text-align: center;">${getTranslation(
            "no_data"
          )}</p>`;
          return;
        }

        container.innerHTML = topCustomers
          .map(
            ([name, total]) => `
          <div class="customer-item" style="padding: 10px; margin: 5px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${name}</strong>
              </div>
              <div style="font-weight: bold; color: #667eea;">
                ${formatCurrency(total)} ${settings.currency || "AED"}
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Product management functions
      function openProductModal() {
        openModal("productModal");
        // Clear form
        document
          .getElementById("productModal")
          .querySelectorAll("input, textarea")
          .forEach((input) => {
            input.value = "";
          });
      }

      function saveProduct() {
        if (!validateForm("productModal")) {
          showAlert(getTranslation("fix_form_errors"), "error");
          return;
        }

        const productData = {
          id: generateId(),
          name: document.getElementById("productName").value.trim(),
          description: document
            .getElementById("productDescription")
            .value.trim(),
          price: parseFloat(document.getElementById("productPrice").value) || 0,
          unit: document.getElementById("productUnit").value.trim(),
          category: document.getElementById("productCategory").value.trim(),
          stock: parseInt(document.getElementById("productStock").value) || 0,
          code: document.getElementById("productCode").value.trim(),
          createdAt: new Date().toISOString(),
        };

        products.push(productData);
        saveData();
        loadProductsList();
        closeModal("productModal");
        clearValidation("productModal");
        showAlert(getTranslation("product_saved"), "success");
      }

      function loadProductsList() {
        const container = document.getElementById("productsList");

        if (products.length === 0) {
          container.innerHTML = `<p style="color: #6c757d; text-align: center; padding: 20px;">${getTranslation(
            "no_products_msg"
          )}</p>`;
          return;
        }

        container.innerHTML = products
          .map(
            (product) => `
          <div class="product-item">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 5px 0; color: #667eea;">${
                  product.name
                }</h4>
                <p style="margin: 0 0 5px 0; color: #6c757d; font-size: 0.9em;">${
                  product.description || "لا يوجد وصف"
                }</p>
                <div style="font-size: 0.9em; color: #495057;">
                  <span style="font-weight: bold;">السعر: ${formatCurrency(
                    product.price
                  )} ${settings.currency || "AED"}</span>
                  ${product.unit ? ` | الوحدة: ${product.unit}` : ""}
                  ${product.category ? ` | الفئة: ${product.category}` : ""}
                  ${product.stock > 0 ? ` | المخزون: ${product.stock}` : ""}
                </div>
                ${
                  product.code
                    ? `<div style="font-size: 0.8em; color: #6c757d;">كود المنتج: ${product.code}</div>`
                    : ""
                }
              </div>
              <div class="item-actions">
                <button class="btn btn-secondary" onclick="editProduct('${
                  product.id
                }')" style="padding: 5px 10px; font-size: 0.8em;">
                  <i class="fas fa-edit"></i> تعديل
                </button>
                <button class="btn btn-danger" onclick="deleteProduct('${
                  product.id
                }')" style="padding: 5px 10px; font-size: 0.8em;">
                  <i class="fas fa-trash"></i> حذف
                </button>
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      function editProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) return;

        // Fill form with product data
        document.getElementById("productName").value = product.name;
        document.getElementById("productDescription").value =
          product.description || "";
        document.getElementById("productPrice").value = product.price;
        document.getElementById("productUnit").value = product.unit || "";
        document.getElementById("productCategory").value =
          product.category || "";
        document.getElementById("productStock").value = product.stock;
        document.getElementById("productCode").value = product.code || "";

        openModal("productModal");

        // Change save button to update
        const saveBtn = document.querySelector("#productModal .btn-success");
        saveBtn.innerHTML = '<i class="fas fa-save"></i> تحديث المنتج';
        saveBtn.onclick = () => updateProduct(productId);
      }

      function updateProduct(productId) {
        const productIndex = products.findIndex((p) => p.id === productId);
        if (productIndex === -1) return;

        products[productIndex] = {
          ...products[productIndex],
          name: document.getElementById("productName").value.trim(),
          description: document
            .getElementById("productDescription")
            .value.trim(),
          price: parseFloat(document.getElementById("productPrice").value) || 0,
          unit: document.getElementById("productUnit").value.trim(),
          category: document.getElementById("productCategory").value.trim(),
          stock: parseInt(document.getElementById("productStock").value) || 0,
          code: document.getElementById("productCode").value.trim(),
          updatedAt: new Date().toISOString(),
        };

        saveData();
        loadProductsList();
        closeModal("productModal");
        clearValidation("productModal");
        showAlert(getTranslation("product_updated"), "success");
      }

      function deleteProduct(productId) {
        if (confirm(getTranslation("delete_product"))) {
          products = products.filter((p) => p.id !== productId);
          saveData();
          loadProductsList();
          showAlert(getTranslation("product_deleted"), "success");
        }
      }

      // Customer management functions
      function openCustomerModal() {
        openModal("customerModal");
        // Clear form
        document
          .getElementById("customerModal")
          .querySelectorAll("input, textarea, select")
          .forEach((input) => {
            input.value = "";
          });
      }

      function saveCustomer() {
        if (!validateForm("customerModal")) {
          showAlert(getTranslation("fix_form_errors"), "error");
          return;
        }

        const customerData = {
          id: generateId(),
          name: document.getElementById("customerName").value.trim(),
          type: document.getElementById("customerType").value,
          phone: document.getElementById("customerPhone").value.trim(),
          email: document.getElementById("customerEmail").value.trim(),
          address: document.getElementById("customerAddress").value.trim(),
          taxNumber: document.getElementById("customerTaxNumber").value.trim(),
          idNumber: document.getElementById("customerIdNumber").value.trim(),
          createdAt: new Date().toISOString(),
        };

        customers.push(customerData);
        saveData();
        loadCustomersList();
        closeModal("customerModal");
        clearValidation("customerModal");
        showAlert(getTranslation("customer_saved"), "success");
      }

      function loadCustomersList() {
        const container = document.getElementById("customersList");

        if (customers.length === 0) {
          container.innerHTML = `<p style="color: #6c757d; text-align: center; padding: 20px;">${getTranslation(
            "no_customers_msg"
          )}</p>`;
          return;
        }

        container.innerHTML = customers
          .map(
            (customer) => `
          <div class="customer-item">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 5px 0; color: #667eea;">${
                  customer.name
                }</h4>
                <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 5px;">
                  ${customer.type === "company" ? "شركة" : "فرد"}
                  ${customer.phone ? ` | ${customer.phone}` : ""}
                  ${customer.email ? ` | ${customer.email}` : ""}
                </div>
                ${
                  customer.address
                    ? `<div style="font-size: 0.9em; color: #495057; margin-bottom: 5px;">${customer.address}</div>`
                    : ""
                }
                <div style="font-size: 0.8em; color: #6c757d;">
                  ${
                    customer.taxNumber
                      ? `رقم الضريبة: ${customer.taxNumber}`
                      : ""
                  }
                  ${
                    customer.idNumber
                      ? ` | رقم الهوية: ${customer.idNumber}`
                      : ""
                  }
                </div>
              </div>
              <div class="item-actions">
                <button class="btn btn-secondary" onclick="editCustomer('${
                  customer.id
                }')" style="padding: 5px 10px; font-size: 0.8em;">
                  <i class="fas fa-edit"></i> تعديل
                </button>
                <button class="btn btn-danger" onclick="deleteCustomer('${
                  customer.id
                }')" style="padding: 5px 10px; font-size: 0.8em;">
                  <i class="fas fa-trash"></i> حذف
                </button>
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      function editCustomer(customerId) {
        const customer = customers.find((c) => c.id === customerId);
        if (!customer) return;

        // Fill form with customer data
        document.getElementById("customerName").value = customer.name;
        document.getElementById("customerType").value = customer.type;
        document.getElementById("customerPhone").value = customer.phone || "";
        document.getElementById("customerEmail").value = customer.email || "";
        document.getElementById("customerAddress").value =
          customer.address || "";
        document.getElementById("customerTaxNumber").value =
          customer.taxNumber || "";
        document.getElementById("customerIdNumber").value =
          customer.idNumber || "";

        openModal("customerModal");

        // Change save button to update
        const saveBtn = document.querySelector("#customerModal .btn-success");
        saveBtn.innerHTML = '<i class="fas fa-save"></i> تحديث العميل';
        saveBtn.onclick = () => updateCustomer(customerId);
      }

      function updateCustomer(customerId) {
        const customerIndex = customers.findIndex((c) => c.id === customerId);
        if (customerIndex === -1) return;

        customers[customerIndex] = {
          ...customers[customerIndex],
          name: document.getElementById("customerName").value.trim(),
          type: document.getElementById("customerType").value,
          phone: document.getElementById("customerPhone").value.trim(),
          email: document.getElementById("customerEmail").value.trim(),
          address: document.getElementById("customerAddress").value.trim(),
          taxNumber: document.getElementById("customerTaxNumber").value.trim(),
          idNumber: document.getElementById("customerIdNumber").value.trim(),
          updatedAt: new Date().toISOString(),
        };

        saveData();
        loadCustomersList();
        closeModal("customerModal");
        clearValidation("customerModal");
        showAlert(getTranslation("customer_updated"), "success");
      }

      function deleteCustomer(customerId) {
        if (confirm(getTranslation("delete_customer"))) {
          customers = customers.filter((c) => c.id !== customerId);
          saveData();
          loadCustomersList();
          showAlert(getTranslation("customer_deleted"), "success");
        }
      }

      // Invoice management functions
      function openInvoiceModal() {
        openModal("invoiceModal");

        // Generate invoice number
        document.getElementById("invoiceNumber").value = `INV-${String(
          currentInvoiceNumber
        ).padStart(4, "0")}`;

        // Set today's date
        document.getElementById("invoiceDate").value = new Date()
          .toISOString()
          .split("T")[0];

        // Load customers
        loadCustomerOptions();

        // Load products
        loadProductOptions();

        // Reset form
        document.getElementById("invoiceCustomer").value = "";
        document.getElementById("paymentMethod").value = "cash";
        document.getElementById("dueDays").value = "30";
        document.getElementById("invoiceTaxRate").value =
          settings.defaultTaxRate || "14";
        document.getElementById("invoiceDiscount").value = "0";
        document.getElementById("invoiceNotes").value = "";

        // Reset items
        const itemsContainer = document.getElementById("invoiceItems");
        itemsContainer.innerHTML = `
          <div class="invoice-item">
            <div class="row">
              <div class="col-3">
                <label>المنتج/الخدمة</label>
                <select class="item-product" onchange="updateItemPrice(this)">
                  <option value="">اختر منتج...</option>
                </select>
              </div>
              <div class="col">
                <label>الكمية</label>
                <input type="number" class="item-quantity" value="1" min="1" onchange="calculateItemTotal(this)">
              </div>
              <div class="col">
                <label>السعر</label>
                <input type="number" class="item-price" step="0.01" onchange="calculateItemTotal(this)">
              </div>
              <div class="col">
                <label>الإجمالي</label>
                <input type="number" class="item-total" step="0.01" readonly>
              </div>
              <div class="col">
                <button class="btn btn-danger" onclick="removeItem(this)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;

        loadProductOptions();
        calculateInvoiceTotal();
      }

      function loadCustomerOptions() {
        const select = document.getElementById("invoiceCustomer");
        select.innerHTML = '<option value="">اختر عميل...</option>';
        customers.forEach((customer) => {
          select.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
        });
      }

      function loadProductOptions() {
        document.querySelectorAll(".item-product").forEach((select) => {
          if (select.innerHTML.includes("اختر منتج...")) {
            select.innerHTML = '<option value="">اختر منتج...</option>';
            products.forEach((product) => {
              select.innerHTML += `<option value="${product.id}" data-price="${
                product.price
              }">${product.name} - ${formatCurrency(product.price)}</option>`;
            });
          }
        });
      }

      function updateItemPrice(selectElement) {
        const selectedOption =
          selectElement.options[selectElement.selectedIndex];
        const priceInput = selectElement
          .closest(".row")
          .querySelector(".item-price");

        if (selectedOption.value && selectedOption.dataset.price) {
          priceInput.value = selectedOption.dataset.price;
          calculateItemTotal(selectElement);
        } else {
          priceInput.value = "";
          calculateItemTotal(selectElement);
        }
      }

      function calculateItemTotal(element) {
        const row = element.closest(".row");
        const quantity =
          parseFloat(row.querySelector(".item-quantity").value) || 0;
        const price = parseFloat(row.querySelector(".item-price").value) || 0;
        const total = quantity * price;

        row.querySelector(".item-total").value = total.toFixed(2);
        calculateInvoiceTotal();
      }

      function addInvoiceItem() {
        const itemsContainer = document.getElementById("invoiceItems");
        const newItem = document.createElement("div");
        newItem.className = "invoice-item";
        newItem.innerHTML = `
          <div class="row">
            <div class="col-3">
              <label>المنتج/الخدمة</label>
              <select class="item-product" onchange="updateItemPrice(this)">
                <option value="">اختر منتج...</option>
              </select>
            </div>
            <div class="col">
              <label>الكمية</label>
              <input type="number" class="item-quantity" value="1" min="1" onchange="calculateItemTotal(this)">
            </div>
            <div class="col">
              <label>السعر</label>
              <input type="number" class="item-price" step="0.01" onchange="calculateItemTotal(this)">
            </div>
            <div class="col">
              <label>الإجمالي</label>
              <input type="number" class="item-total" step="0.01" readonly>
            </div>
            <div class="col">
              <button class="btn btn-danger" onclick="removeItem(this)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;

        itemsContainer.appendChild(newItem);
        loadProductOptions();
      }

      function removeItem(button) {
        const itemsContainer = document.getElementById("invoiceItems");
        if (itemsContainer.children.length > 1) {
          button.closest(".invoice-item").remove();
          calculateInvoiceTotal();
        } else {
          showAlert(getTranslation("min_one_item"), "warning");
        }
      }

      function calculateInvoiceTotal() {
        let subtotal = 0;

        document.querySelectorAll(".item-total").forEach((totalInput) => {
          subtotal += parseFloat(totalInput.value) || 0;
        });

        const discountRate =
          parseFloat(document.getElementById("invoiceDiscount").value) || 0;
        const discountAmount = (subtotal * discountRate) / 100;
        const afterDiscount = subtotal - discountAmount;

        const taxRate =
          parseFloat(document.getElementById("invoiceTaxRate").value) || 0;
        const taxAmount = (afterDiscount * taxRate) / 100;
        const total = afterDiscount + taxAmount;

        document.getElementById("subtotal").textContent =
          formatCurrency(subtotal);
        document.getElementById("discountAmount").textContent =
          formatCurrency(discountAmount);
        document.getElementById("taxAmount").textContent =
          formatCurrency(taxAmount);
        document.getElementById("totalAmount").textContent =
          formatCurrency(total);
      }

      function saveInvoice() {
        const invoiceData = collectInvoiceData();
        if (!validateInvoice(invoiceData)) return;

        invoices.push(invoiceData);
        currentInvoiceNumber++;
        saveData();
        loadInvoicesList();
        closeModal("invoiceModal");
        clearValidation("invoiceModal");
        showAlert(getTranslation("invoice_saved"), "success");
        updateDashboard();
      }

      function saveAndPrintInvoice() {
        const invoiceData = collectInvoiceData();
        if (!validateInvoice(invoiceData)) return;

        invoices.push(invoiceData);
        currentInvoiceNumber++;
        saveData();

        // Display invoice for printing
        displayInvoice(invoiceData);
        closeModal("invoiceModal");
        updateDashboard();
      }

      function collectInvoiceData() {
        const items = [];
        document.querySelectorAll(".invoice-item").forEach((itemElement) => {
          const row = itemElement.querySelector(".row");
          const productSelect = row.querySelector(".item-product");
          const quantity =
            parseFloat(row.querySelector(".item-quantity").value) || 0;
          const price = parseFloat(row.querySelector(".item-price").value) || 0;
          const total = parseFloat(row.querySelector(".item-total").value) || 0;

          if (productSelect.value && quantity > 0 && price > 0) {
            const product = products.find((p) => p.id === productSelect.value);
            items.push({
              productId: productSelect.value,
              productName: product ? product.name : "منتج غير محدد",
              quantity: quantity,
              price: price,
              total: total,
            });
          }
        });

        const subtotal = items.reduce((sum, item) => sum + item.total, 0);
        const discountRate =
          parseFloat(document.getElementById("invoiceDiscount").value) || 0;
        const discountAmount = (subtotal * discountRate) / 100;
        const afterDiscount = subtotal - discountAmount;
        const taxRate =
          parseFloat(document.getElementById("invoiceTaxRate").value) || 0;
        const taxAmount = (afterDiscount * taxRate) / 100;
        const total = afterDiscount + taxAmount;

        const customerId = document.getElementById("invoiceCustomer").value;
        const customer = customers.find((c) => c.id === customerId);

        return {
          id: generateId(),
          number: document.getElementById("invoiceNumber").value,
          date: document.getElementById("invoiceDate").value,
          customerId: customerId,
          customerName: customer ? customer.name : "عميل غير محدد",
          paymentMethod: document.getElementById("paymentMethod").value,
          dueDays: parseInt(document.getElementById("dueDays").value) || 30,
          items: items,
          subtotal: subtotal,
          discountRate: discountRate,
          discountAmount: discountAmount,
          taxRate: taxRate,
          taxAmount: taxAmount,
          total: total,
          notes: document.getElementById("invoiceNotes").value.trim(),
          createdAt: new Date().toISOString(),
        };
      }

      function validateInvoice(invoiceData) {
        if (!invoiceData.number) {
          showAlert(getTranslation("invoice_number_required"), "error");
          return false;
        }
        if (!invoiceData.date) {
          showAlert(getTranslation("invoice_date_required"), "error");
          return false;
        }
        if (invoiceData.items.length === 0) {
          showAlert(getTranslation("invoice_items_required"), "error");
          return false;
        }
        return true;
      }

      function loadInvoicesList() {
        const container = document.getElementById("invoicesList");

        if (invoices.length === 0) {
          container.innerHTML = `<p style="color: #6c757d; text-align: center; padding: 20px;">${getTranslation(
            "no_invoices_msg"
          )}</p>`;
          return;
        }

        container.innerHTML = invoices
          .slice()
          .reverse()
          .map(
            (invoice) => `
          <div class="invoice-item">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 5px 0; color: #667eea;">فاتورة #${
                  invoice.number
                }</h4>
                <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 5px;">
                  ${new Date(invoice.date).toLocaleDateString("ar-EG")} - ${
              invoice.customerName
            }
                </div>
                <div style="font-size: 0.9em; color: #495057;">
                  ${invoice.items.length} عنصر | ${
              invoice.paymentMethod === "cash"
                ? "نقداً"
                : invoice.paymentMethod === "card"
                ? "بطاقة ائتمان"
                : invoice.paymentMethod === "bank"
                ? "تحويل بنكي"
                : "شيك"
            }
                </div>
                ${
                  invoice.notes
                    ? `<div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">${invoice.notes}</div>`
                    : ""
                }
              </div>
              <div style="text-align: left;">
                <div style="font-weight: bold; color: #28a745; font-size: 1.2em;">
                  ${formatCurrency(invoice.total)} ${settings.currency || "AED"}
                </div>
                <div class="item-actions" style="margin-top: 10px;">
                  <button class="btn btn-primary" onclick="displayInvoice('${
                    invoice.id
                  }')" style="padding: 5px 10px; font-size: 0.8em;">
                    <i class="fas fa-eye"></i> عرض
                  </button>
                  <button class="btn btn-secondary" onclick="editInvoice('${
                    invoice.id
                  }')" style="padding: 5px 10px; font-size: 0.8em;">
                    <i class="fas fa-edit"></i> تعديل
                  </button>
                  <button class="btn btn-danger" onclick="deleteInvoice('${
                    invoice.id
                  }')" style="padding: 5px 10px; font-size: 0.8em;">
                    <i class="fas fa-trash"></i> حذف
                  </button>
                </div>
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      function displayInvoice(invoiceId) {
        const invoice = invoices.find((i) => i.id === invoiceId);
        if (!invoice) return;

        // Display company info
        document.getElementById("displayCompanyName").textContent =
          settings.companyName || "اسم الشركة";
        document.getElementById("displayCompanyAddress").textContent =
          settings.companyAddress || "العنوان";
        document.getElementById("displayCompanyPhone").textContent =
          settings.companyPhone || "---";
        document.getElementById("displayCompanyEmail").textContent =
          settings.companyEmail || "---";

        // Display invoice info
        document.getElementById("displayInvoiceNumber").textContent =
          invoice.number;
        document.getElementById("displayInvoiceDate").textContent = new Date(
          invoice.date
        ).toLocaleDateString("ar-EG");

        const dueDate = new Date(invoice.date);
        dueDate.setDate(dueDate.getDate() + invoice.dueDays);
        document.getElementById("displayDueDate").textContent =
          dueDate.toLocaleDateString("ar-EG");

        document.getElementById("displayPaymentMethod").textContent =
          invoice.paymentMethod === "cash"
            ? "Cash"
            : invoice.paymentMethod === "card"
            ? "Credit Card"
            : invoice.paymentMethod === "bank"
            ? "Bank Transfer"
            : "Check";

        // Display customer info
        const customer = customers.find((c) => c.id === invoice.customerId);
        document.getElementById("displayCustomerInfo").innerHTML = `
          <div style="font-size: 1.1em; margin-bottom: 10px;"><strong>${
            invoice.customerName
          }</strong></div>
          ${
            customer && customer.phone
              ? `<div style="margin-bottom: 5px;"><strong>Phone:</strong> ${customer.phone}</div>`
              : ""
          }
          ${
            customer && customer.email
              ? `<div style="margin-bottom: 5px;"><strong>Email:</strong> ${customer.email}</div>`
              : ""
          }
          ${
            customer && customer.address
              ? `<div style="margin-bottom: 5px;"><strong>Address:</strong> ${customer.address}</div>`
              : ""
          }
        `;

        // Display items
        const itemsBody = document.getElementById("displayItemsBody");
        itemsBody.innerHTML = invoice.items
          .map(
            (item) => `
          <tr>
            <td style="text-align: left;">${item.productName}</td>
            <td style="text-align: center;">${item.quantity}</td>
            <td style="text-align: center;">---</td>
            <td style="text-align: center;">${formatCurrency(item.price)}</td>
            <td style="text-align: right;">${formatCurrency(item.total)}</td>
          </tr>
        `
          )
          .join("");

        // Display totals
        document.getElementById("displaySubtotal").textContent = formatCurrency(
          invoice.subtotal
        );
        document.getElementById("displayDiscount").textContent = formatCurrency(
          invoice.discountAmount
        );
        document.getElementById("displayTax").textContent = formatCurrency(
          invoice.taxAmount
        );
        document.getElementById("displayTotal").textContent = formatCurrency(
          invoice.total
        );

        // Display notes
        if (invoice.notes) {
          document.getElementById("displayNotes").innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: left;">
              <h4 style="margin: 0 0 10px 0; color: #495057;">Notes:</h4>
              <p style="margin: 0; line-height: 1.5;">${invoice.notes}</p>
            </div>
          `;
        } else {
          document.getElementById("displayNotes").innerHTML = "";
        }

        // Show invoice display
        document.getElementById("invoiceDisplay").style.display = "block";
        document.querySelector(".app").style.display = "none";
      }

      function printInvoice() {
        window.print();
      }

      function closeInvoiceDisplay() {
        document.getElementById("invoiceDisplay").style.display = "none";
        document.querySelector(".app").style.display = "block";
      }

      function editInvoice(invoiceId) {
        // Implementation for editing invoices
        showAlert(getTranslation("edit_invoice_coming"), "info");
      }

      function deleteInvoice(invoiceId) {
        if (confirm(getTranslation("delete_invoice"))) {
          invoices = invoices.filter((i) => i.id !== invoiceId);
          saveData();
          loadInvoicesList();
          showAlert(getTranslation("invoice_deleted"), "success");
          updateDashboard();
        }
      }

      // Settings functions
      function saveSettings() {
        settings = {
          companyName: document.getElementById("companyName").value.trim(),
          companyPhone: document.getElementById("companyPhone").value.trim(),
          companyEmail: document.getElementById("companyEmail").value.trim(),
          companyWebsite: document
            .getElementById("companyWebsite")
            .value.trim(),
          companyAddress: document
            .getElementById("companyAddress")
            .value.trim(),
          defaultTaxRate:
            parseFloat(document.getElementById("defaultTaxRate").value) || 14,
          currency: document.getElementById("defaultCurrency").value,
        };

        saveData();
        showAlert(getTranslation("settings_saved"), "success");
      }

      function exportData() {
        const data = {
          invoices: invoices,
          products: products,
          customers: customers,
          settings: settings,
          exportDate: new Date().toISOString(),
        };

        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(dataBlob);
        link.download = `invoice-data-${
          new Date().toISOString().split("T")[0]
        }.json`;
        link.click();
      }

      function importData() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";

        input.onchange = function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = JSON.parse(e.target.result);

              if (data.invoices) invoices = data.invoices;
              if (data.products) products = data.products;
              if (data.customers) customers = data.customers;
              if (data.settings) settings = data.settings;

              saveData();
              loadLists();
              updateDashboard();
              showAlert(getTranslation("data_imported"), "success");
            } catch (error) {
              showAlert(getTranslation("import_error"), "error");
            }
          };
          reader.readAsText(file);
        };

        input.click();
      }

      // Search and filter functions
      function filterInvoices() {
        const searchTerm = document
          .getElementById("invoiceSearch")
          .value.toLowerCase();
        const invoiceItems = document.querySelectorAll(
          "#invoicesList .invoice-item"
        );

        invoiceItems.forEach((item) => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(searchTerm) ? "block" : "none";
        });
      }

      function filterProducts() {
        const searchTerm = document
          .getElementById("productSearch")
          .value.toLowerCase();
        const productItems = document.querySelectorAll(
          "#productsList .product-item"
        );

        productItems.forEach((item) => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(searchTerm) ? "block" : "none";
        });
      }

      function filterCustomers() {
        const searchTerm = document
          .getElementById("customerSearch")
          .value.toLowerCase();
        const customerItems = document.querySelectorAll(
          "#customersList .customer-item"
        );

        customerItems.forEach((item) => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(searchTerm) ? "block" : "none";
        });
      }

      // Initialize app
      function initializeApp() {
        // Load settings into form
        if (settings.companyName)
          document.getElementById("companyName").value = settings.companyName;
        if (settings.companyPhone)
          document.getElementById("companyPhone").value = settings.companyPhone;
        if (settings.companyEmail)
          document.getElementById("companyEmail").value = settings.companyEmail;
        if (settings.companyWebsite)
          document.getElementById("companyWebsite").value =
            settings.companyWebsite;
        if (settings.companyAddress)
          document.getElementById("companyAddress").value =
            settings.companyAddress;
        if (settings.defaultTaxRate)
          document.getElementById("defaultTaxRate").value =
            settings.defaultTaxRate;
        if (settings.currency)
          document.getElementById("defaultCurrency").value = settings.currency;
      }

      function loadLists() {
        loadInvoicesList();
        loadProductsList();
        loadCustomersList();
      }

      // Add some sample data for demonstration
      function addSampleData() {
        if (products.length === 0) {
          products = [
            {
              id: "sample1",
              name: "خدمة استشارية",
              description: "خدمة استشارية في مجال الأعمال",
              price: 500,
              unit: "ساعة",
              category: "خدمات",
              stock: 0,
              code: "CONS-001",
              createdAt: new Date().toISOString(),
            },
            {
              id: "sample2",
              name: "منتج رقمي",
              description: "منتج رقمي قابل للتحميل",
              price: 299,
              unit: "قطعة",
              category: "منتجات رقمية",
              stock: 100,
              code: "DIG-001",
              createdAt: new Date().toISOString(),
            },
          ];
        }

        if (customers.length === 0) {
          customers = [
            {
              id: "sample1",
              name: "شركة النمو المحدودة",
              type: "company",
              phone: "+971501234567",
              email: "info@company.com",
              address: "دبي، الإمارات العربية المتحدة",
              taxNumber: "123456789",
              idNumber: "987654321",
              createdAt: new Date().toISOString(),
            },
            {
              id: "sample2",
              name: "أحمد محمد",
              type: "individual",
              phone: "+971507654321",
              email: "ahmed@email.com",
              address: "أبوظبي، الإمارات العربية المتحدة",
              taxNumber: "",
              idNumber: "1234567890123",
              createdAt: new Date().toISOString(),
            },
          ];
        }

        if (!settings.companyName) {
          settings = {
            companyName: "شركتي للخدمات",
            companyPhone: "+971501234567",
            companyEmail: "info@mycompany.com",
            companyWebsite: "www.mycompany.com",
            companyAddress: "دبي، الإمارات العربية المتحدة",
            defaultTaxRate: 14,
            currency: "AED",
          };
        }

        saveData();
        loadLists();
        updateDashboard();
        initializeApp();
      }

      // Beautiful Alert System
      function showAlert(message, type = "info", duration = 5000) {
        const alertContainer = document.getElementById("alertContainer");
        const alertId = "alert-" + Date.now();

        const alertTypes = {
          success: { icon: "✅", class: "alert-success" },
          error: { icon: "❌", class: "alert-error" },
          warning: { icon: "⚠️", class: "alert-warning" },
          info: { icon: "ℹ️", class: "alert-info" },
        };

        const alertConfig = alertTypes[type] || alertTypes.info;

        const alertHTML = `
          <div id="${alertId}" class="alert ${alertConfig.class}">
            <span class="alert-icon">${alertConfig.icon}</span>
            <div class="alert-content">${message}</div>
            <button class="alert-close" onclick="hideAlert('${alertId}')">&times;</button>
          </div>
        `;

        alertContainer.insertAdjacentHTML("beforeend", alertHTML);

        // Auto hide after duration
        if (duration > 0) {
          setTimeout(() => {
            hideAlert(alertId);
          }, duration);
        }
      }

      function hideAlert(alertId) {
        const alert = document.getElementById(alertId);
        if (alert) {
          alert.classList.add("hide");
          setTimeout(() => {
            alert.remove();
          }, 300);
        }
      }

      // Form Validation Functions
      function validateForm(formId) {
        const form = document.getElementById(formId);
        if (!form) return false;

        const inputs = form.querySelectorAll(
          "input[required], select[required], textarea[required]"
        );
        let isValid = true;

        inputs.forEach((input) => {
          const formGroup = input.closest(".form-group");
          if (!formGroup) return;

          // Remove previous validation classes
          formGroup.classList.remove("error", "success");
          const existingError = formGroup.querySelector(".error-message");
          if (existingError) existingError.remove();

          if (!input.value.trim()) {
            formGroup.classList.add("error");
            const errorMsg = document.createElement("div");
            errorMsg.className = "error-message";
            errorMsg.textContent = getTranslation("field_required");
            formGroup.appendChild(errorMsg);
            isValid = false;
          } else {
            formGroup.classList.add("success");

            // Additional validations
            if (input.type === "email" && input.value) {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(input.value)) {
                formGroup.classList.remove("success");
                formGroup.classList.add("error");
                const errorMsg = document.createElement("div");
                errorMsg.className = "error-message";
                errorMsg.textContent = getTranslation("invalid_email");
                formGroup.appendChild(errorMsg);
                isValid = false;
              }
            }

            if (input.type === "number") {
              const value = parseFloat(input.value);
              if (isNaN(value) || value < 0) {
                formGroup.classList.remove("success");
                formGroup.classList.add("error");
                const errorMsg = document.createElement("div");
                errorMsg.className = "error-message";
                errorMsg.textContent = getTranslation("invalid_number");
                formGroup.appendChild(errorMsg);
                isValid = false;
              }
            }
          }
        });

        return isValid;
      }

      function clearValidation(formId) {
        const form = document.getElementById(formId);
        if (!form) return;

        const formGroups = form.querySelectorAll(".form-group");
        formGroups.forEach((group) => {
          group.classList.remove("error", "success");
          const errorMsg = group.querySelector(".error-message");
          if (errorMsg) errorMsg.remove();
        });
      }
    </script>
  </body>
</html>
